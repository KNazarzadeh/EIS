classdef ESPMsimulation

    properties (Constant, Access = private)
        calcGeom   = GeometricParametersCalculator();
        calcConc   = ConcentrationParametersCalculator();
        calcKin    = KineticParametersCalculator();
        calcTherm  = ThermodynamicParametersCalculator();        
        calcElec   = ElectricalParametersCalculator();
    end
    
    methods(Static)
        %% ESPM Simulation Full-Cell Analysis
        function battery = runESPMsimulation(battery, PreComPM, applied_current, timeSize, timeStep)
           
            % ============================
            % === 1) One-time setup  ====
            % ============================
            t0 = tic;
            % =====================================
            % === 2) Time integration main loop ===
            % =====================================
            time = 1;
            timeVector = zeros(timeSize,1);
            simulationEnd = 0;

            for nsteps = SimulationParams.timeStep:SimulationParams.timeStep:SimulationParams.timeFinal
                battery = ESPMsimulation.updateElectrodeParams(battery, "negative", ...                    
                    applied_current(time+1), PreComPM, time);

                battery = ESPMsimulation.updatePositiveElectrodeParams(battery, "positive", applied_current(time+1), ...
                    PreComPM, timeStep, time);
                
                battery = ESPMsimulation.updateElectrolyteParams(battery, PreComPM, time);

                battery = ESPMsimulation.updateRestNegativeElectrodeParams(battery, "negative", time);
                battery = ESPMsimulation.updateRestPositiveElectrodeParams(battery, "positive", time);

                % ========= Termination Conditions ==========
                if battery.ElectricalParams.cell.('voltage')(time+1, :) < battery.ElectricalParams.cell.('lower_voltage_cell') || ...
                        battery.ElectricalParams.cell.('voltage')(time+1, :) > battery.ElectricalParams.cell.('upper_voltage_cell')
                    break;
                end
                if timeStep < 1e-60
                    break;
                end

                if simulationEnd || time >= timeSize-1 || time >= length(applied_current), break; end

                timeVector(time+1, :) = timeVector(time, :) + timeStep;
                time = time + 1;

            end
            
            battery.SimulationParams.runtime = toc(t0);

            battery.SimulationParams.timeVector = timeVector' ;
            battery.ElectricalParams.cell.applied_current = applied_current(2:end);

            % Compute cell capacity for full simulation
             battery.ElectricalParams.cell.cell_capacity = ...
                  ESPMsimulation.calcElec.compute_Cell_Capacity(battery);
        end

        %% Update Values of Parameters
        function battery = updateElectrodeParams(battery, electrode, applied_current, ...
                preComputedMatrix, time)

            prefix = electrode{1}(1:3);
        
            % Compute molar ionic flux                 
            battery.KineticParams.electrode.(electrode).(['molar_ionic_flux_' prefix])(time+1, :) = ESPMsimulation.calcKin.compute_molar_ionic_flux( ...
                battery, applied_current, ...
                battery.GeometricParams.electrode.(electrode).particles.(['specific_interfacial_surface_area_' prefix])(time+1), ...
                electrode);           

            % Compute electrode concentration
            battery.ConcentrationParams.electrode.(electrode).(['concentration_' prefix])(:,time+1) = ESPMsimulation.calcConc.compute_electrode_concentration( ...
                preComputedMatrix.electrode.(electrode).Acs_hat, ...
                preComputedMatrix.electrode.(electrode).boundaryConcentrationDiscreteTimeMatrix, ...
                battery.ConcentrationParams.electrode.(electrode).(['concentration_' prefix])(:,time), ...
                battery.KineticParams.electrode.(electrode).(['molar_ionic_flux_' prefix])(time+1));
    
            % Surface Concentration
            battery.ConcentrationParams.electrode.(electrode).(['surface_concentration_' prefix])(time+1, :) = ESPMsimulation.calcConc.compute_electrode_surface_concentration( ...
                battery.ConcentrationParams.electrode.(electrode).(['concentration_' prefix])(:,time+1), preComputedMatrix.electrode.(electrode).Acs_bar);
            
            % Average Concentration
            battery.ConcentrationParams.electrode.(electrode).(['average_concentration_' prefix])(time+1, :) = ESPMsimulation.calcConc.compute_electrode_average_concentration( ...
                    battery, battery.ConcentrationParams.electrode.(electrode).(['concentration_' prefix])(:,time+1), electrode);
    
            % Compute Aging stoichiometry
            battery.ThermodynamicParams.electrode.(electrode).(['aging_stoichiometry_' prefix])(time+1, :) = ESPMsimulation.calcTherm.compute_aging_stoichiometry( ...
                battery.ConcentrationParams.electrode.(electrode).(['average_concentration_' prefix])(time+1), ...
                battery.ConcentrationParams.electrode.(electrode).(['concentration_maximum_' prefix]));
    
            % Compute stoichiometry
            battery.ThermodynamicParams.electrode.(electrode).(['stoichiometry_' prefix])(time+1, :) = ESPMsimulation.calcTherm.compute_stoichiometry( ...
                battery.ConcentrationParams.electrode.(electrode).(['surface_concentration_' prefix])(time+1), ...
                battery.ConcentrationParams.electrode.(electrode).(['concentration_maximum_' prefix]));
            
            % Compute equilibrium potential
            battery.ThermodynamicParams.electrode.(electrode).(['equilibrium_potential_' prefix])(time+1, :) = ...
                ESPMsimulation.calcTherm.compute_electrode_equilibrium_potential( ...
                battery.ThermodynamicParams.electrode.(electrode).(['equilibrium_potential_equation_' prefix]), ...
                battery.ThermodynamicParams.electrode.(electrode).(['stoichiometry_' prefix])(time+1));
        end

        %% Helper function for Electrolyte Parameters Update
        function battery = updateElectrolyteParams(battery, preComputedMatrix, time)

            % Compute Elelctrolyte Concentration 
            battery.ConcentrationParams.electrolyte.concentration_elyte(:, time+1) = ...
                ESPMsimulation.calcConc.compute_electrolyte_concentration( ...
                preComputedMatrix.electrolyte.surfaceDiffusionElyteDiscreteTime, ...
                preComputedMatrix.electrolyte.boundaryFluxElectrolyteDiscreteTime, ...
                battery.KineticParams.electrode.negative.molar_ionic_flux_neg(time+1), ...
                battery.KineticParams.electrode.positive.molar_ionic_flux_pos(time+1), ...
                battery.ConcentrationParams.electrolyte.concentration_elyte(:, time));

            % Compute Mean Elelctrolyte Concentration 
            battery.ConcentrationParams.electrolyte.concentration_mean_elyte_neg(time+1, :) = ...
                ESPMsimulation.calcConc.compute_electrolyte_mean_concentration(battery,"negative", ...
                battery.ConcentrationParams.electrolyte.concentration_elyte(:,time+1));

            battery.ConcentrationParams.electrolyte.concentration_mean_elyte_pos(time+1, :) = ...
                ESPMsimulation.calcConc.compute_electrolyte_mean_concentration(battery,"positive", ...
                battery.ConcentrationParams.electrolyte.concentration_elyte(:,time+1));

         % Compute Elelctrolyte Potential 
            battery.ThermodynamicParams.electrolyte.potential_elyte(:,time+1) = ...
                ESPMsimulation.calcTherm.compute_electrolyte_potential( ...
                    preComputedMatrix.electrolyte.boundaryPotentialElyteDiscreteTime, ...
                    preComputedMatrix.electrolyte.surfacePotentialElyteMatrix, ...
                    preComputedMatrix.electrolyte.diffusionPotentialElyteMatrix, ...
                    battery.KineticParams.electrode.negative.molar_ionic_flux_neg(time+1), ...
                    battery.KineticParams.electrode.positive.molar_ionic_flux_pos(time+1), ...
                    battery.ConcentrationParams.electrolyte.concentration_elyte(:,time+1));
            
           % Compute Mean Elelctrolyte Potential         
           battery.ThermodynamicParams.electrolyte.potential_mean_elyte_neg(time+1, :) = ...
               ESPMsimulation.calcTherm.compute_electrolyte_mean_potential(battery, ...
               battery.ThermodynamicParams.electrolyte.potential_elyte(:,time+1),"negative");
           battery.ThermodynamicParams.electrolyte.potential_mean_elyte_pos(time+1, :) = ...
               ESPMsimulation.calcTherm.compute_electrolyte_mean_potential(battery, ...
               battery.ThermodynamicParams.electrolyte.potential_elyte(:,time+1),"positive");
        end

        %% Helper function for Electrode Parameters Update
        function battery = updateRestElectrodeParams(battery, electrode, time)

            sei_film_resistance = battery.ElectricalParams.electrode.(electrode).(['sei_film_resistance_' prefix])(time+1);
            
            battery.KineticParams.electrode.(electrode).(['exchange_current_density_' prefix])(time+1, :) = ...
                ESPMsimulation.calcKin.compute_exchange_current_density(battery, ...
                        battery.ConcentrationParams.electrode.(electrode).(['surface_concentration_' prefix])(time+1), ...
                        battery.ConcentrationParams.electrolyte.concentration_mean_elyte_' prefix])(time+1), ...
                        electrode);
    
            battery.ThermodynamicParams.electrode.(electrode).(['overpotential_' prefix])(time+1, :) = ...
                ESPMsimulation.calcTherm.compute_electrode_overpotential(battery, ...
                battery.KineticParams.electrode.(electrode).(['molar_ionic_flux_' prefix])(time+1), ...
                battery.KineticParams.electrode.(electrode).(['exchange_current_density_' prefix])(time+1), ...
                 battery.ThermodynamicParams.electrolyte.([potential_mean_elyte_' prefix])(time+1), ...
                sei_film_resistance, electrode);   
    
            battery.ThermodynamicParams.electrode.(electrode).(['potential_' prefix])(time+1, :) = ...
                ESPMsimulation.calcTherm.compute_electrode_potential( ...
                battery.ThermodynamicParams.electrode.(electrode).(['overpotential_' prefix])(time+1), ...
                battery.ThermodynamicParams.electrode.(electrode).(['equilibrium_potential_' prefix])(time+1));
    
        end
    
        %% Helper function for Electrode Parameters Update
        function battery = updateRestPositiveElectrodeParams(battery, electrode, time)
            sei_film_resistance = battery.ElectricalParams.electrode.positive.sei_film_resistance_pos(1);
    
            battery.KineticParams.electrode.positive.exchange_current_density_pos(time+1, :) = ...
                ESPMsimulation.calcKin.compute_exchange_current_density(battery, ...
                        battery.ConcentrationParams.electrode.positive.surface_concentration_pos(time+1), ...
                        battery.ConcentrationParams.electrolyte.concentration_mean_elyte_pos(time+1), ...
                        electrode);
    
            battery.ThermodynamicParams.electrode.positive.overpotential_pos(time+1, :) = ...
                ESPMsimulation.calcTherm.compute_electrode_overpotential(battery, ...
                battery.KineticParams.electrode.positive.molar_ionic_flux_pos(time+1), ...
                battery.KineticParams.electrode.positive.exchange_current_density_pos(time+1), ...
                 battery.ThermodynamicParams.electrolyte.potential_mean_elyte_pos(time+1), ...
                sei_film_resistance, electrode);   
    
            battery.ThermodynamicParams.electrode.positive.potential_pos(time+1, :) = ...
                ESPMsimulation.calcTherm.compute_electrode_potential( ...
                battery.ThermodynamicParams.electrode.positive.overpotential_pos(time+1), ...
                battery.ThermodynamicParams.electrode.positive.equilibrium_potential_pos(time+1));
    
        end
        
        %% Helper function for Electrode Parameters Update
        function battery = updateCell(battery, applied_current, cycleNum, timeStep, time)
            
                % ========== Update Cell voltage
                battery.ElectricalParams.cell.voltage(time+1, :) = ESPMsimulation.calcElec.compute_cell_voltage(battery, ...
                    applied_current, time);
    
                % ========== Update SOC
                battery.ElectricalParams.cell.SOC(time+1, :) = ESPMsimulation.calcElec.compute_SOC(battery, ...
                    applied_current, ...
                    battery.ElectricalParams.cell.SOC(time), ...
                    battery.ElectricalParams.cell.battery_capacity_cell(cycleNum,1), timeStep);

        end
     
    end
end
