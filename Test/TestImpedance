clear all;
close all;
clc;
% profile clear                              % reset old data
% profile on -timer real                     % wall-clock timing (good default)
%% Set Input file
databasePath = "C:\Users\k.nazarzadeh\Projects\EIS";

inputFileName = "knazarzadeh_ESPM_Pouch_cells_EIS.xlsx";
%% Battery Parameters
% Read Battery Parameters from Excel file
batteryStruct = readExcel(fullfile(databasePath, inputFileName));
battery = Battery(batteryStruct);   % <-- now it's a handle
%% Simulation Parameters
model = "ESPM";

% Initial State of Charge (SOC) as a fraction (0 = 0%, 1 = 100%)
% Example: 0 or "0%" or '0%'
SOC_initial = 0.5;
% C-rate for charging/discharging (e.g., 1C = full charge/discharge in 1 hour)
C_rate = NaN;
thermal_mode = NaN;
% Operating temperature in degrees Celsius
temperature = 25;
% Analysis mode: "full-cell" or "half-cell"
cell_analysis_mode = "full-cell";
cycle_startmode = "discharge";

%% Run Impedance
freq_min = 200e-6;    % 200 µHz
freq_max = 1e3;       % 1000 Hz (1 kHz)

numFreqPoints = 65;            % Number of frequency points

frequencies = logspace(log10(freq_min), log10(freq_max), numFreqPoints);  % descending order
% frequencies = flip(frequencies);  % optional: make it ascending

I_app_amplitude = 0.05;           % Applied current amplitude [A]

samples_per_period = 100;         % Number of time points per period
num_periods = 10;                 % Number of periods to simulate

% --- Output arrays ---
impedance = zeros(length(frequencies), 1);

num_periods_warmup = 5;      % simulate extra cycles, then keep last 10

for i = 1:length(frequencies)
    f = frequencies(i);
    period = 1 / f;
    dt = period / samples_per_period;
    
    t_eval = (0:(samples_per_period * num_periods) - 1) * dt;
    
    % Sinusoidal current
    applied_current = I_app_amplitude * sin(2 * pi * f * t_eval).';
    applied_current_vectors(:, i) = applied_current; % Cell array to store vectors
    
    % Simulation end time in seconds
    % timeFinal = num_periods * period;
    timeFinal = t_eval(end) + 10*eps(t_eval(end));
    % timeFinal = t_eval(end);
    % Time step size in seconds
    timeStep = dt;
    
        % Run Simulation
    simulation(model, ...
        battery, ...
        SOC_initial, ...
        applied_current, ...
        C_rate, ...
        cycle_startmode, ...
        temperature, ...
        thermal_mode, ...
        cell_analysis_mode, ...
        timeFinal, ...
        timeStep);

    % --- Get simulated voltage and align vectors ---
    voltage = battery.ElectricalParams.cell.voltage;
    voltage_vectors(:, i) = voltage;

    num_points_last_three = 3 * samples_per_period + 1;
    start_idx = length(t_eval) - num_points_last_three + 1;
    current_last = applied_current(start_idx:end);
    voltage_last = voltage(start_idx:end);

    % Apply FFT to cell voltage
    voltage_fft = fft(voltage_last) / length(voltage_last);
    current_fft = fft(current_last) / length(current_last);

    % Get first harmonic (frequency index ≈ 5th in this case)
    [~, idx] = max(abs(current_fft));  % peak at fundamental freq

    % Compute impedance
    impedance_tmp = voltage_fft(idx) / current_fft(idx);
    
   
end

%% Plot Nyquist Diagram
figure
plot(real(impedance),-imag(impedance),'. -k','MarkerSize',10);
axis equal
xlabel('$Z_\mathrm{r}(\omega)$ [m$\Omega$]','Interpreter','latex','FontSize',11);
ylabel('$-Z_\mathrm{j}(\omega)$ [m$\Omega$]','Interpreter','latex','FontSize',11); 

